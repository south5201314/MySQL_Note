# 事务

## 事务的简介

* 事务由单独单元的一个或多个SQL语句组成，在这个单元中，每个SQL语句是互相依赖的。

* 事务的特点：

  * 原子性（Atomicity）

    原子性是指事务是一个不可分割的工作单位，事务中的操作要么都发生，要么都不发生。

  * 一致性（Consistency）

    事务必须使数据库从一个一致性状态变换到另外一个一致性状态 。

  * 隔离性（Isolation）

    事务的隔离性是指一个事务的执行不能被其他事务干扰，即一个事务内部的操作及使用的数据对并发的其他事务是隔离的，并发执行的各个事务之间不能互相干扰。

  * 持久性（Durability）

    持久性是指一个事务一旦被提交，它对数据库中数据的改变就是永久性的，接下来的其他操作和数据库故障不应该对其有任何影响。

## 事务隔离级别

* 对于同时运行的多个事务, 当这些事务访问数据库中相同的数据时, 如果没有采取必要的隔离机制, 就会导致各种并发问题: 
  * 脏读: 对于两个事务 T1, T2, T1 读取了已经被 T2 更新但还没有被提交的字段之后, 若 T2 回滚, T1读取的内容就是临时且无效的。
  * 不可重复读: 对于两个事务T1, T2, T1 读取了一个字段, 然后 T2 更新了该字段之后, T1再次读取同一个字段, 值就不同了。
  * 幻读: 对于两个事务T1, T2, T1 从一个表中读取了一个字段, 然后 T2 在该表中插入了一些新的行之后, 如果 T1 再次读取同一个表, 就会多出几行。

* 数据库的四种事务隔离级别：

  | 隔离级别             | 描述                                                         |
  | -------------------- | ------------------------------------------------------------ |
  | READ UNCOMMITED      | 允许事务读取未被其它事务提交的变更，脏读、不可重复读和欢读的问题都会出现 |
  | READ COMMITED        | 只允许事务读取已经被其它事务提交的变更，可以避免脏读，但不可重复读和幻读仍然出现 |
  | REPEATABLE READ      | 确保事务可以多次从一个字段中读取相同的值，在这个事务持续期间，禁止其它事务对这个字段进行更新，可以避免脏读和不可重复读，但幻读的问题仍然存在 |
  | SERIALIZABLE(串行花) | 确保事务可以从一个表中读取相同的行，在这个事务持续期间，禁止其它事务对该表执行插入、更新和删除操作，所有并发问题都可以避免，但性能低下。 |

* 说明：
  * Oricle支持2种事务隔离级别：READ COMMITED和SERIALIZABLE。默认事务隔离级别为：READ COMMITED。
  * MySQL支持4种事务隔离级别，默认事务隔离级别为：REPEATABLE READ。

## 设置隔离级别

* 查看当前隔离级别

  ```mysql
  SELECT @@tx_isolation;
  ```

* 设置当前MySQL连接会话的隔离级别

  ```mysql
  SET TRANSACTION ISOLATION LEVEL 隔离级别;
  ```

* 设置数据库系统的全局隔离级别

  ```mysql
  SET GLOBAL TRANSACTION ISOLATION LEVEL 隔离级别;
  ```

# 事务处理

## 事务的使用

```mysql
SET autocommit = 0; #关闭自动提交
START TRANSACTION; #开启事务,执行这条语句之后并没有真正开启事务，是在第一条SQL语句被执行的时才开启
... #SQL语句
COMMIT; #提交
ROLLBACK; #回滚

#以下不经常使用，了解即可 
SAVEPOINT 断点; #设置一个断点，用于标记位置，断点的名称可以随便起
COMMIT TO 断点; #提交断点处的结果，断点后执行的语句是无效的
ROLLBACK 断点; #回滚到断点处
```